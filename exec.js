#!/usr/bin/env node

import*as e from"colors";import{createRequire as r}from"module";import*as o from"@capacitor/core";var t={n:e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return t.d(r,{a:r}),r},d:(e,r)=>{for(var o in r)t.o(r,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:r[o]})},o:(e,r)=>Object.prototype.hasOwnProperty.call(e,r)};const n=(l={default:()=>e.default},i={},t.d(i,l),i),a=r(import.meta.url)("path"),s=r(import.meta.url)("url");var l,i;const d=(e=>{var r={};return t.d(r,e),r})({Capacitor:()=>o.Capacitor}),c=(0,s.fileURLToPath)("file:///Users/timmoritzkuehle/Library/CloudStorage/Dropbox/Dokumente/Coding/ionic-web-app-dev-proxy/Code/constants.js"),p=(a.dirname(c),"undefined"!=typeof process?null===process||void 0===process?void 0:process.env:void 0),u=(!d.Capacitor.isNativePlatform()&&(void 0===p.MODE||p.MODE),"undefined"!=typeof process&&process.argv.includes("--webpack-watch")),g="localhost",v=`http://${g}:8910`,m=[v],f=e=>{switch(e){case 200:return"OK";case 400:return"Bad Request";case 401:return"Unauthorized";case 403:return"Forbidden";case 404:return"Not Found";case 413:return"Content Too Large";case 500:return"Internal Server Error";default:return"Unknown Error"}},y=(e,r)=>{!1!==e?console.log("Shutting down proxy server for web app development ... "+(r?n.default.red(`\nError: ${null==r?void 0:r.message}`):n.default.green("Success"))+"\n"):console.log("Proxy server is not running\n")},w=(e,r)=>{var o,t;let a;a="EADDRINUSE"===e.code?`Error: listen EADDRINUSE: [${v}] is already in use.`:(null===(t=null===(o=e.stack)||void 0===o?void 0:o.split("\n"))||void 0===t?void 0:t[0])||`Error: ${e.code}: ${e.message}`,a=a.replace(/\[[^\]]+\]/g,(e=>n.default.yellow(e.replace(/[[\]]/g,"")))),console.log(n.default.red((r?h:"  ➜ ")+a+(r?"":"\n")))},h=n.default.grey((new Date).toLocaleTimeString(Intl.DateTimeFormat().resolvedOptions().locale))+n.default.cyan.bold(" [webAppDevProxy] "),$=(e,r,o)=>{console.log(h+(o?n.default.yellow("resolving preflight request ➜ "):n.default.green("resolving request ➜ "))+n.default.gray("Status: ")+(e>=200&&e<=299?n.default.green(`${e} - ${f(e)}`):n.default.red(`${e} - ${f(e)}`+(r?`: ${r}`:""))))},b=(e,r)=>{var o;console.log(n.default.red(((null===(o=e.stack)||void 0===o?void 0:o.split("\n")[0])||`Error: ${e.code}: ${x(e.message)}`)+(r?n.default.cyan(`\n\n${x(r)}\n`):"")))},x=e=>e.replace(/ionic-web-app-dev-proxy|\[[^\]]+\]/g,(e=>n.default.yellow(e.replace(/[[\]]/g,"")))),S=r(import.meta.url)("http");var E=t.n(S);const O=(e,r=null)=>{e.setHeader("Access-Control-Allow-Origin",r||"*"),e.setHeader("Access-Control-Allow-Headers","Content-Type, Authorization")},T=(e,r,o)=>{const t=(null==o?void 0:o.contentType)||"application/json";$(r),o&&e.setHeader("Content-Type",t),e.writeHead(r),e.end(o?((e,r)=>"application/json"===r?JSON.stringify(e):e.toString())(o.data,t):null)},I=(e,r,o,t,n=null)=>{$(o,t),r.setHeader("Content-Type","application/json"),r.writeHead(o),r.end(JSON.stringify({error:{code:o,http_status:o,message:`${o}: ${f(o)}`,data:n?{debug:n}:{}}})),e.destroy()},N=(e,r)=>{r&&w(r),e&&e.listening?e.close((e=>{y(!0,e)})):y(!1)};let P;switch(process.argv.length<=2&&(b({code:"EMISSARG",message:"Missing argument: ionic-web-app-dev-proxy needs to be provided with a command to execute"},"Note: Valid commands are [serveWithProxy] and [startProxyServer]"),process.exit(1)),process.argv[2]){case"startProxyServer":if(process.argv.length<=3){b({code:"ENOIONADDRARG",message:"Missing argument: [startProxyServer] has to be provided with an Ionic serve address to resolve preflight requests"},"Example: ionic-web-app-dev-proxy [startProxyServer http://localhost:8100]");break}P=(e=>{(()=>{if("undefined"==typeof process)throw new Error("Error: Incompatible environment: This script is supposed to run in a nodeJS environment")})(),console.log((u?"\n":"")+"Starting proxy server for web app development ...\n");let r=null;try{if(!/^(https?:\/\/(www\.)?([\w0-9-]+\.?)+([a-z]{2,63})?|([0-9]{1,3}\.){3}[0-9]{1,3}):[0-9]{1,5}$/.test(e))throw new Error(`Invalid Parameter: [${e}] is not a valid Ionic app development server address`);r=E().createServer(((r,o)=>{var t;const a=(null===(t=r.url)||void 0===t?void 0:t.replace(/^\//,""))||"/";((e,r)=>{const o="OPTIONS"===r;console.log(h+(o?n.default.yellow("incoming preflight request ➜ "):n.default.green("incoming request ➜ "))+n.default.grey(`URL: ${(o?n.default.yellow:n.default.green)(e)}`+(o?"":` Method: ${n.default.green(r||"UNKNOWN")}`)))})(a,r.method),"OPTIONS"!==r.method?(O(o,r.headers.origin),((e,r,o)=>!!/^https?:\/\/(www\.)?([\w0-9-]+\.)+[a-z]{2,63}(\/[\w0-9-]+)*(\.[\w0-9]+)*([?&][\w0-9-_]+=[\w0-9-_%]*)*$/.test(o)||(I(e,r,400,"Target URL is invalid"),!1))(r,o,a)&&((e,r,o)=>{const t=e.headers["content-type"]||"application/json";let n="",a=0;e.on("data",(o=>{if(a+=o.length,a>2097152){const o="Request body size exceeds proxy server maximum limit (2MB)";I(e,r,413,o,`HTTP Error: 413: ${o}`)}else n+=o})),e.on("end",(async()=>{try{const a=await fetch(o,{method:e.method,headers:{"Content-Type":t},body:n}),s=a.headers.get("content-type")||"application/json",l="application/json"===t?await a.json():a.text();T(r,a.status,{contentType:s,data:l})}catch(o){const{stack:t,code:n,message:a}=o,s=(null==t?void 0:t.split("\n")[0])||`Error: ${n}: ${a}`;I(e,r,500,s,t)}}))})(r,o,a)):((e,r,o)=>{const{origin:t}=e.headers;O(r);let n=null;t?[...m,o].includes(t)||(n={code:403,message:`Origin [${t}] is not allowed to access proxy server`}):n={code:400,message:"Proxy server is unable to determine request origin"},n?I(e,r,n.code,n.message):T(r,200)})(r,o,e)})).listen(8910,g,(()=>{console.log(`${n.default.green(`  ➜ ${v}`)}\n`)})).on("error",(e=>{w(e,!0)}))}catch(e){N(r,e)}return r})(process.argv[3]);break;default:b({code:"EINVARG",message:`Invalid argument: [${process.argv[2]}] is not a valid command`}),process.exit(1)}process.on("SIGINT",(()=>{process.stdout.write("\n"),N(P)})),process.on("SIGTERM",(()=>{N(P)}));