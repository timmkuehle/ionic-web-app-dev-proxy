#!/usr/bin/env node

import*as e from"colors";import{createRequire as r}from"module";import*as o from"@capacitor/core";var t={n:e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return t.d(r,{a:r}),r},d:(e,r)=>{for(var o in r)t.o(r,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:r[o]})},o:(e,r)=>Object.prototype.hasOwnProperty.call(e,r)};const n=(l={default:()=>e.default},i={},t.d(i,l),i),s=r(import.meta.url)("path"),a=r(import.meta.url)("url");var l,i;const d=(e=>{var r={};return t.d(r,e),r})({Capacitor:()=>o.Capacitor}),c=(0,a.fileURLToPath)("file:///Users/timmoritzkuehle/Library/CloudStorage/Dropbox/Dokumente/Coding/ionic-web-app-dev-proxy/Code/constants.js"),p=(s.dirname(c),"undefined"!=typeof process?null===process||void 0===process?void 0:process.env:void 0),u=(!d.Capacitor.isNativePlatform()&&(void 0===p.MODE||p.MODE),"undefined"!=typeof process&&process.argv.includes("--webpack-watch")),g="localhost",v=`http://${g}:8910`,m=[v],y=/Development server running!/,f=/Local: |\n/g,h=/hmr update/,w=()=>{if("undefined"==typeof process)throw new Error("Error: Incompatible environment: This script is supposed to run in a nodeJS environment")},I=e=>{switch(e){case 200:return"OK";case 400:return"Bad Request";case 401:return"Unauthorized";case 403:return"Forbidden";case 404:return"Not Found";case 413:return"Content Too Large";case 500:return"Internal Server Error";default:return"Unknown Error"}},S=(e,r)=>{!1!==e?console.log("Shutting down proxy server for web app development ... "+(r?n.default.red(`\nError: ${null==r?void 0:r.message}`):"")+"\n"):console.log("Proxy server is not running\n")},$=(e,r)=>{var o,t;let s;s="EADDRINUSE"===e.code?`Error: listen EADDRINUSE: [${v}] is already in use.`:(null===(t=null===(o=e.stack)||void 0===o?void 0:o.split("\n"))||void 0===t?void 0:t[0])||`Error: ${e.code}: ${e.message}`,console.log(n.default.red((r?x:"  ➜ ")+N(s)+(r?"":"\n")))},x=n.default.grey((new Date).toLocaleTimeString(Intl.DateTimeFormat().resolvedOptions().locale))+n.default.cyan.bold(" [webAppDevProxy] "),b=(e,r,o)=>{console.log(x+(o?n.default.yellow("resolving preflight request ➜ "):n.default.green("resolving request ➜ "))+n.default.gray("Status: ")+(e>=200&&e<=299?n.default.green(`${e} - ${I(e)}`):n.default.red(`${e} - ${I(e)}`+(r?`: ${r}`:""))))},E=e=>{!1!==e?console.log("Shutting down Ionic app development server ...\n"):console.log("Ionic app development server is not running\n")},T=e=>{console.log(n.default.red("  ➜ Error: Unable to serve Ionic App")+n.default.cyan(`\n\nNote: The ${n.default.yellow("serveWithProxy")} script is supposed to run in an Ionic project directory.\nPlease make sure that the Ionic CLI is installed on your system and that \nthis script is executed in the root directory of your Ionic project.\nIf you intend to run the proxy server only, use the ${n.default.yellow("startProxyServer")} script.\nFor more information, read the original error message below.\n\n`)+n.default.red(e.message))},P=(e,r)=>{var o;console.log(n.default.red(((null===(o=e.stack)||void 0===o?void 0:o.split("\n")[0])||`Error: ${e.code}: ${N(e.message)}`)+(r?n.default.cyan(`\n\n${N(r)}\n`):"")))},N=e=>e.replace(/ionic-web-app-dev-proxy|\[[^\]]+\]/g,(e=>n.default.yellow(e.replace(/[[\]]/g,"")))),O=r(import.meta.url)("child_process"),R=r(import.meta.url)("http");var k=t.n(R);const C=(e,r=null)=>{e.setHeader("Access-Control-Allow-Origin",r||"*"),e.setHeader("Access-Control-Allow-Headers","Content-Type, Authorization")},D=(e,r,o)=>{const t=(null==o?void 0:o.contentType)||"application/json";b(r),o&&e.setHeader("Content-Type",t),e.writeHead(r),e.end(o?((e,r)=>"application/json"===r?JSON.stringify(e):e.toString())(o.data,t):null)},A=(e,r,o,t,n=null)=>{b(o,t),r.setHeader("Content-Type","application/json"),r.writeHead(o),r.end(JSON.stringify({error:{code:o,http_status:o,message:`${o}: ${I(o)}`,data:n?{debug:n}:{}}})),e.destroy()},M=e=>!!/^(https?:\/\/(www\.)?([\w0-9-]+\.?)+([a-z]{2,63})?|([0-9]{1,3}\.){3}[0-9]{1,3}):[0-9]{1,5}$/.test(e),j=e=>{w(),console.log((u?"\n":"")+"Starting proxy server for web app development ...\n");let r=null;try{if(!M(e))throw new Error(`Invalid Parameter: [${e}] is not a valid Ionic app development server address`);r=k().createServer(((r,o)=>{var t;const s=(null===(t=r.url)||void 0===t?void 0:t.replace(/^\//,""))||"/";((e,r)=>{const o="OPTIONS"===r;console.log(x+(o?n.default.yellow("incoming preflight request ➜ "):n.default.green("incoming request ➜ "))+n.default.grey(`URL: ${(o?n.default.yellow:n.default.green)(e)}`+(o?"":` Method: ${n.default.green(r||"UNKNOWN")}`)))})(s,r.method),"OPTIONS"!==r.method?(C(o,r.headers.origin),((e,r,o)=>!!/^https?:\/\/(www\.)?([\w0-9-]+\.)+[a-z]{2,63}(\/[\w0-9-]+)*(\.[\w0-9]+)*([?&][\w0-9-_]+=[\w0-9-_%]*)*$/.test(o)||(A(e,r,400,"Target URL is invalid"),!1))(r,o,s)&&((e,r,o)=>{const t=e.headers["content-type"]||"application/json";let n="",s=0;e.on("data",(o=>{if(s+=o.length,s>2097152){const o="Request body size exceeds proxy server maximum limit (2MB)";A(e,r,413,o,`HTTP Error: 413: ${o}`)}else n+=o})),e.on("end",(async()=>{try{const s=await fetch(o,{method:e.method,headers:{"Content-Type":t},body:n}),a=s.headers.get("content-type")||"application/json",l="application/json"===t?await s.json():s.text();D(r,s.status,{contentType:a,data:l})}catch(o){const{stack:t,code:n,message:s}=o,a=(null==t?void 0:t.split("\n")[0])||`Error: ${n}: ${s}`;A(e,r,500,a,t)}}))})(r,o,s)):((e,r,o)=>{const{origin:t}=e.headers;C(r);let n=null;t?[...m,o].includes(t)||(n={code:403,message:`Origin [${t}] is not allowed to access proxy server`}):n={code:400,message:"Proxy server is unable to determine request origin"},n?A(e,r,n.code,n.message):D(r,200)})(r,o,e)})).listen(8910,g,(()=>{console.log(`${n.default.green(`  ➜ ${v}`)}\n`)})).on("error",(e=>{$(e,!0)}))}catch(e){U(r,e)}return r},U=(e,r)=>{r&&$(r),e&&e.listening?e.close((e=>{S(!0,e),process.exit(e?1:0)})):S(!1)},G=(e,r,o)=>{o&&T(o),e&&!e.killed?e.kill(r):E(!1)};let L,q;switch(process.argv.length<=2&&(P({code:"EMISSARG",message:"Missing argument: ionic-web-app-dev-proxy needs to be provided with a command to execute"},"Note: Valid commands are [serveWithProxy] and [startProxyServer]"),process.exit(1)),process.argv[2]){case"serveWithProxy":L=(()=>{w(),console.log((u?"\n":"")+"Starting Ionic app development server ...\n");const e=(0,O.spawn)("ionic",["serve","--no-open"]);e.on("error",(e=>{T(e)})),e.stderr.on("data",(e=>{T({message:e.toString()})}));let r=null;return e.stdout.on("data",(o=>{const t=o.toString();if(y.test(o)){const o=((e,r)=>{const o=e.match(/Local: .*\n/);if(!o||!o.length)return G(r,"SIGTERM",{message:"Error: Unable to retrieve local Ionic app development server URL"}),null;const t=o[0].replace(f,"");return M(t)?t:(G(r,"SIGTERM",{message:`Error: [${t}] is not a valid Ionic app development server address`}),null)})(t,e);if(!o)return;return s=o,console.log(n.default.green(`  ➜ ${s}\n`)),r=j(o),void(r||G(e,"SIGTERM"))}var s;(e=>{h.test(e)&&console.log(e.replace(/^\[(vite|webpack)\] |\n/g,""))})(t)})),e.on("close",(()=>{E(),r&&U(r)})),e})();break;case"startProxyServer":if(process.argv.length<=3){P({code:"ENOIONADDRARG",message:"Missing argument: [startProxyServer] has to be provided with an Ionic serve address to resolve preflight requests"},"Example: ionic-web-app-dev-proxy [startProxyServer http://localhost:8100]");break}q=j(process.argv[3]);break;default:P({code:"EINVARG",message:`Invalid argument: [${process.argv[2]}] is not a valid command`}),process.exit(1)}process.on("SIGINT",(()=>{process.stdout.write("\n"),L&&G(L,"SIGINT"),q&&U(q)})),process.on("SIGTERM",(()=>{L&&G(L,"SIGTERM"),q&&U(q)}));